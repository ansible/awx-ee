---
version: 1
build_arg_defaults:
  EE_BASE_IMAGE: 'ghcr.io/daveshow/ansible-runner:devel'
  EE_BUILDER_IMAGE: 'ghcr.io/daveshow/ansible-builder:devel'
dependencies:
  galaxy: _build/requirements.yml
  system: _build/bindep.txt
  python: _build/requirements.txt
additional_build_steps:
  prepend:
    - RUN /usr/bin/python3 -m pip install --no-cache-dir --upgrade pip
  append:
    - RUN alternatives --set python /usr/bin/python3
    - COPY --from=quay.io/ansible/receptor:devel /usr/bin/receptor /usr/bin/receptor
    - COPY --from=1password/op:1.12.5 /usr/local/bin/op /usr/bin/op
    - COPY --from=imega/jq:latest /usr/bin/jq /usr/bin/jq
    - COPY --from=imega/jq:latest /usr/lib/* /usr/lib/
    - COPY --from=imega/jq:latest /lib/* /lib/
    - COPY --from=hashicorp/packer:light /bin/packer /usr/sbin/packer
    - RUN mkdir -p /var/run/receptor
    - RUN python -m pip uninstall -y ansible-core && python -m pip install --force ansible==2.9.27
    - ADD run.sh /run.sh
    - CMD /run.sh
    - USER 1000
    - RUN git lfs install
